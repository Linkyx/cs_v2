"use strict";define(["ui","../apis/message","bootstrapValidator","jquery.serializeObject"],function(require,exports,module){require("bootstrapValidator"),require("jquery.serializeObject");var UI=require("ui"),Message=require("../apis/message");$("#message_form").formValidation({autoFocus:!0,framework:"bootstrap",icon:{valid:!1,invalid:!1,validating:"fa fa-refresh"},row:{valid:"has-success"},fields:{title:{validators:{notEmpty:{message:"标题不能为空"}}},receivers:{validators:{notEmpty:{message:"收件人不能为空"}}}}}).on("success.form.fv",function(e){function resolve(res){res&&res.id?UI.alert({message:"send"===data.status?"消息发送成功~":"草稿保存成功~"}).then(function(){window.location.href="/messages/"+res.id}):UI.alert({message:"send"===data.status?"消息发送失败，请稍后再试~":"草稿保存失败，请稍后再试"})}function reject(err){console.log(err),UI.alert({message:"send"===data.status?"消息发送失败，请稍后再试~":"草稿保存失败，请稍后再试"})}e.preventDefault();var $form=$(e.target),fv=$form.data("formValidation"),$btn=fv.getSubmitButton(),action=$btn.data("action"),data=$("#message_form").serializeObject();if(data.content=window.editor.codemirror.getValue(),!data.content)return fv.disableSubmitButtons(!1),UI.alert("内容不能为空~");"send"===action?data.status="send":data.status="save";var messageId=$("#data_message_id").val();messageId?Message.update(messageId,data).then(function(res){resolve(res)}).catch(function(err){reject(err)}):Message.create(data).then(function(res){resolve(res)}).catch(function(err){reject(err)})})});